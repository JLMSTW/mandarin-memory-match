<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>句子重組｜Mandarin Sentence Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',system-ui,-apple-system,'Noto Sans TC',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:24px;color:#fff}
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:2rem;text-align:center;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin:16px 0 10px}
    .toolbar select,.toolbar button,.toolbar label{background:#fff;color:#2c3e50;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
    .toolbar button{background:linear-gradient(135deg,#ff9a9e,#fecfef);cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.18)}
    .toolbar input[type="checkbox"]{vertical-align:-2px;margin-right:6px}

    .zones{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
    .zone{min-height:108px;background:rgba(255,255,255,.15);border:2px dashed rgba(255,255,255,.55);
      border-radius:16px;padding:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start}
    .zone-title{font-weight:800;margin-bottom:6px;opacity:.9}
    .bank{background:rgba(255,255,255,.12)}
    .drop-hover{outline:3px solid #ffe08a}

    .token{user-select:none;cursor:grab;background:#fff;color:#2c3e50;border-radius:12px;padding:8px 10px;
      display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 6px 14px rgba(0,0,0,.2);
      font-weight:800}
    .token:active{cursor:grabbing}
    .hanzi{font-family:'Noto Sans TC',sans-serif;font-size:1.15rem}
    .pinyin{font-size:.85rem;opacity:.85;display:none}
    .show-pinyin .pinyin{display:block}

    .status{margin-top:10px;text-align:center;font-weight:800}
    .status.ok{color:#c8ffb0}
    .status.err{color:#ffe08a}

    @media (min-width:900px){
      .zones{grid-template-columns:1fr 1fr}
      .zone{min-height:140px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧩 句子重組（拖曳排序）</h1>

    <div class="toolbar">
      <label style="background:transparent;color:#fff;border:none;padding:0">題目：</label>
      <select id="sentenceSelect" title="選擇題目"></select>
      <label><input type="checkbox" id="togglePinyin" />顯示拼音</label>
      <button id="shuffleBtn">🔀 重洗</button>
      <button id="resetBtn">↩️ 重置</button>
      <button id="checkBtn">✅ 檢查答案</button>
      <button id="nextBtn">➡️ 下一題</button>
    </div>

    <div class="zones">
      <div>
        <div class="zone-title">把詞塊拖到這裡 →（可拖曳調整順序）</div>
        <div id="answerZone" class="zone"></div>
      </div>
      <div>
        <div class="zone-title">詞庫（拖曳到上面）</div>
        <div id="bankZone" class="zone bank"></div>
      </div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <script>
    // 六句題目：每題以「詞塊」設計，標點也獨立為詞塊；提供對應拼音做提示
    const DATA = [
      {
        id: 1,
        hanzi: ["因為","一些","原因","，","裝潢","要","再","延","一個月","。"],
        pinyin:["yīn wèi","yí xiē","yuán yīn","","zhuāng huáng","yào","zài","yán","yí gè yuè",""]
      },
      {
        id: 2,
        hanzi: ["你","說得","太快","，","請你","再","說","一次","！"],
        pinyin:["nǐ","shuō de","tài kuài","","qǐng nǐ","zài","shuō","yí cì",""]
      },
      {
        id: 3,
        hanzi: ["這家","餐廳","很","道地","，","我","可以","再","去","很多次","。"],
        pinyin:["zhè jiā","cān tīng","hěn","dào dì","","wǒ","kě yǐ","zài","qù","hěn duō cì",""]
      },
      {
        id: 4,
        hanzi: ["你們","想要","再","喝","一杯","啤酒","嗎","？"],
        pinyin:["nǐ men","xiǎng yào","zài","hē","yì bēi","pí jiǔ","ma",""]
      },
      {
        id: 5,
        hanzi: ["我","已經","說過","很多次","了","，","我","不想","再","解釋","了","！"],
        pinyin:["wǒ","yǐ jīng","shuō guò","hěn duō cì","le","","wǒ","bù xiǎng","zài","jiě shì","le",""]
      },
      {
        id: 6,
        hanzi: ["他","還","沒好","，","我們","要","再","等","他","五分鐘","。"],
        pinyin:["tā","hái","méi hǎo","","wǒ men","yào","zài","děng","tā","wǔ fēn zhōng",""]
      }
    ];

    // ---- DOM 元素
    const answerZone = document.getElementById('answerZone');
    const bankZone = document.getElementById('bankZone');
    const selectEl = document.getElementById('sentenceSelect');
    const togglePinyin = document.getElementById('togglePinyin');
    const statusEl = document.getElementById('status');

    const btnShuffle = document.getElementById('shuffleBtn');
    const btnReset = document.getElementById('resetBtn');
    const btnCheck = document.getElementById('checkBtn');
    const btnNext = document.getElementById('nextBtn');

    // ---- 狀態
    let current = 0;          // 目前題目 index
    let showPinyin = false;   // 拼音顯示

    // ---- 初始化下拉
    function initSelect(){
      DATA.forEach((q,i)=>{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `第 ${q.id} 題`;
        selectEl.appendChild(opt);
      });
    }

    // ---- 產生 token 元素
    function createToken(sentenceIdx, tokenIdx){
      const tId = `${sentenceIdx}-${tokenIdx}`;
      const wrap = document.createElement('div');
      wrap.className = 'token';
      wrap.draggable = true;
      wrap.dataset.tokenId = tId;
      wrap.dataset.hanzi = DATA[sentenceIdx].hanzi[tokenIdx];

      const hz = document.createElement('div');
      hz.className = 'hanzi';
      hz.textContent = DATA[sentenceIdx].hanzi[tokenIdx];

      const py = document.createElement('div');
      py.className = 'pinyin';
      py.textContent = DATA[sentenceIdx].pinyin[tokenIdx];

      wrap.append(hz,py);

      // DnD handlers
      wrap.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', tId);
        setTimeout(()=> wrap.style.opacity = '0.6', 0);
      });
      wrap.addEventListener('dragend', ()=> wrap.style.opacity = '1');

      // 雙擊送回詞庫
      wrap.addEventListener('dblclick', ()=>{
        bankZone.appendChild(wrap);
      });

      return wrap;
    }

    function clearZones(){
      answerZone.innerHTML = '';
      bankZone.innerHTML = '';
    }

    // 洗牌
    function shuffle(arr){
      const a = [...arr];
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // 載入題目
    function loadSentence(idx, shuffleBank=true){
      current = idx;
      selectEl.value = String(idx);
      statusEl.textContent = '';

      clearZones();
      const { hanzi } = DATA[idx];

      const order = shuffleBank ? shuffle([...hanzi.keys()]) : [...hanzi.keys()];
      order.forEach(ti=>{
        bankZone.appendChild(createToken(idx, ti));
      });

      // 拼音顯示狀態
      document.body.classList.toggle('show-pinyin', showPinyin);
    }

    // 檢查答案
    function checkAnswer(){
      const target = DATA[current].hanzi.join('');
      const built = [...answerZone.querySelectorAll('.token')].map(el=>el.dataset.hanzi).join('');
      if (built === target){
        statusEl.textContent = '✅ 正確！做得好～';
        statusEl.className = 'status ok';
      } else {
        statusEl.textContent = '⚠️ 還差一點點，再調整看看！';
        statusEl.className = 'status err';
      }
    }

    // ---- DnD 區域（答案 / 詞庫）行為
    [answerZone, bankZone].forEach(zone=>{
      zone.addEventListener('dragover', e=>{
        e.preventDefault();
        zone.classList.add('drop-hover');

        // 允許在答案區內部「插入到某 token 前」
        const afterEl = getDragAfterElement(zone, e.clientX, e.clientY);
        const draggingId = e.dataTransfer?.getData('text/plain');
        const dragging = draggingId ? document.querySelector(`[data-token-id="${draggingId}"]`) : null;
        if (afterEl == null) {
          // no specific target, show as append (visual only)
        } else {
          // visual hint handled by CSS gap
        }
      });

      zone.addEventListener('dragleave', ()=> zone.classList.remove('drop-hover'));

      zone.addEventListener('drop', e=>{
        e.preventDefault();
        zone.classList.remove('drop-hover');
        const id = e.dataTransfer.getData('text/plain');
        const token = document.querySelector(`[data-token-id="${id}"]`);
        if (!token) return;

        // 在游標位置前插入
        const afterEl = getDragAfterElement(zone, e.clientX, e.clientY);
        if (afterEl == null) zone.appendChild(token);
        else zone.insertBefore(token, afterEl);
      });
    });

    // 找到游標之後的最近元素（方便在中間插入）
    function getDragAfterElement(container, x, y){
      const els = [...container.querySelectorAll('.token:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const rect = child.getBoundingClientRect();
        // 計算滑鼠到元素中心的距離
        const offset = Math.hypot(x - (rect.left+rect.width/2), y - (rect.top+rect.height/2));
        if (offset < closest.offset) return { offset, element: child };
        else return closest;
      }, { offset: Number.POSITIVE_INFINITY, element: null }).element;
    }

    // 事件綁定
    togglePinyin.addEventListener('change', ()=>{
      showPinyin = togglePinyin.checked;
      document.body.classList.toggle('show-pinyin', showPinyin);
    });

    btnShuffle.addEventListener('click', ()=> loadSentence(current, true));
    btnReset.addEventListener('click', ()=> loadSentence(current, false));
    btnCheck.addEventListener('click', checkAnswer);
    btnNext.addEventListener('click', ()=>{
      const next = (current + 1) % DATA.length;
      loadSentence(next, true);
    });

    selectEl.addEventListener('change', e=> loadSentence(Number(e.target.value), true));

    // 啟動
    (function start(){
      initSelect();
      loadSentence(0, true);
    })();
  </script>
</body>
</html>
