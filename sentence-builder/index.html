<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sentence Builder | Mandarin</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Inter:wght@600;800&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter','Noto Sans TC',system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:24px;color:#fff
    }
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:2rem;text-align:center;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin:16px 0 10px}
    .toolbar .label{background:transparent;color:#fff;border:none;padding:0;font-weight:800}
    .select,.btn{background:#fff;color:#2c3e50;border:none;border-radius:12px;padding:10px 14px;font-weight:800}
    .btn{background:linear-gradient(135deg,#ff9a9e,#fecfef);cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.18)}
    .zones{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
    .zone{min-height:108px;background:rgba(255,255,255,.15);border:2px dashed rgba(255,255,255,.55);
      border-radius:16px;padding:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start}
    .zone-title{font-weight:900;margin-bottom:6px;opacity:.9}
    .bank{background:rgba(255,255,255,.12)}
    .drop-hover{outline:3px solid #ffe08a}

    .token{
      user-select:none;cursor:grab;background:#fff;color:#2c3e50;border-radius:12px;padding:8px 10px;
      display:flex;flex-direction:column;align-items:center;gap:4px;box-shadow:0 6px 14px rgba(0,0,0,.2);
      font-weight:900
    }
    .token:active{cursor:grabbing}
    .hanzi{font-family:'Noto Sans TC',sans-serif;font-size:1.15rem}
    .pinyin{font-size:.85rem;opacity:.85;display:block} /* æ°¸é é¡¯ç¤ºæ‹¼éŸ³ */

    /* æ’å…¥ä½ç½®æç¤ºç®­é ­ */
    .insertion-marker{
      background:#fff;color:#2c3e50;border-radius:10px;padding:4px 8px;
      font-weight:900;font-family:ui-monospace,Menlo,monospace;align-self:center;
      box-shadow:0 4px 10px rgba(0,0,0,.2)
    }

    .status{margin-top:10px;text-align:center;font-weight:900}
    .status.ok{color:#c8ffb0}
    .status.err{color:#ffe08a}

    @media (min-width:900px){
      .zones{grid-template-columns:1fr 1fr}
      .zone{min-height:140px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§© Mandarin Sentence Builder</h1>

    <div class="toolbar">
      <span class="label">Sentence:</span>
      <select id="sentenceSelect" class="select" title="Choose a sentence"></select>
      <button id="shuffleBtn" class="btn">ğŸ”€ Shuffle</button>
      <button id="resetBtn" class="btn">â†©ï¸ Reset</button>
      <button id="checkBtn" class="btn">âœ… Check</button>
      <button id="nextBtn" class="btn">â¡ï¸ Next</button>
    </div>

    <div class="zones">
      <div>
        <div class="zone-title">Build here (drag & reorder)</div>
        <div id="answerZone" class="zone"></div>
      </div>
      <div>
        <div class="zone-title">Word bank</div>
        <div id="bankZone" class="zone bank"></div>
      </div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <script>
    // Sentences (Hanzi + Pinyin)
    const DATA = [
      { id:1,
        hanzi:["å› ç‚º","ä¸€äº›","åŸå› ","ï¼Œ","è£æ½¢","è¦","å†","å»¶","ä¸€å€‹æœˆ","ã€‚"],
        pinyin:["yÄ«n wÃ¨i","yÃ­ xiÄ“","yuÃ¡n yÄ«n","","zhuÄng huÃ¡ng","yÃ o","zÃ i","yÃ¡n","yÃ­ gÃ¨ yuÃ¨",""] },
      { id:2,
        hanzi:["ä½ ","èªªå¾—","å¤ªå¿«","ï¼Œ","è«‹ä½ ","å†","èªª","ä¸€æ¬¡","ï¼"],
        pinyin:["nÇ","shuÅ de","tÃ i kuÃ i","","qÇng nÇ","zÃ i","shuÅ","yÃ­ cÃ¬",""] },
      { id:3,
        hanzi:["é€™å®¶","é¤å»³","å¾ˆ","é“åœ°","ï¼Œ","æˆ‘","å¯ä»¥","å†","å»","å¾ˆå¤šæ¬¡","ã€‚"],
        pinyin:["zhÃ¨ jiÄ","cÄn tÄ«ng","hÄ›n","dÃ o dÃ¬","","wÇ’","kÄ› yÇ","zÃ i","qÃ¹","hÄ›n duÅ cÃ¬",""] },
      { id:4,
        hanzi:["ä½ å€‘","æƒ³è¦","å†","å–","ä¸€æ¯","å•¤é…’","å—","ï¼Ÿ"],
        pinyin:["nÇ men","xiÇng yÃ o","zÃ i","hÄ“","yÃ¬ bÄ“i","pÃ­ jiÇ”","ma",""] },
      { id:5,
        hanzi:["æˆ‘","å·²ç¶“","èªªé","å¾ˆå¤šæ¬¡","äº†","ï¼Œ","æˆ‘","ä¸æƒ³","å†","è§£é‡‹","äº†","ï¼"],
        pinyin:["wÇ’","yÇ jÄ«ng","shuÅ guÃ²","hÄ›n duÅ cÃ¬","le","","wÇ’","bÃ¹ xiÇng","zÃ i","jiÄ› shÃ¬","le",""] },
      { id:6,
        hanzi:["ä»–","é‚„","æ²’å¥½","ï¼Œ","æˆ‘å€‘","è¦","å†","ç­‰","ä»–","äº”åˆ†é˜","ã€‚"],
        pinyin:["tÄ","hÃ¡i","mÃ©i hÇo","","wÇ’ men","yÃ o","zÃ i","dÄ›ng","tÄ","wÇ” fÄ“n zhÅng",""] }
    ];

    const answerZone = document.getElementById('answerZone');
    const bankZone = document.getElementById('bankZone');
    const selectEl = document.getElementById('sentenceSelect');
    const statusEl = document.getElementById('status');
    const btnShuffle = document.getElementById('shuffleBtn');
    const btnReset = document.getElementById('resetBtn');
    const btnCheck = document.getElementById('checkBtn');
    const btnNext = document.getElementById('nextBtn');

    let current = 0;

    // Single insertion marker element (shows "<" or ">")
    const marker = document.createElement('div');
    marker.className = 'insertion-marker';
    marker.style.display = 'none';

    function initSelect(){
      DATA.forEach((q,i)=>{
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `#${q.id}`;
        selectEl.appendChild(opt);
      });
    }

    function createToken(si, ti){
      const wrap = document.createElement('div');
      wrap.className = 'token'; wrap.draggable = true;
      wrap.dataset.hanzi = DATA[si].hanzi[ti];

      const hz = document.createElement('div');
      hz.className = 'hanzi'; hz.textContent = DATA[si].hanzi[ti];

      const py = document.createElement('div');
      py.className = 'pinyin'; py.textContent = DATA[si].pinyin[ti];

      wrap.append(hz, py);

      wrap.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', `${si}-${ti}`);
        setTimeout(()=> wrap.style.opacity = '0.6', 0);
      });
      wrap.addEventListener('dragend', ()=>{
        wrap.style.opacity = '1';
        hideMarker();
      });
      // Double-click to send back to bank
      wrap.addEventListener('dblclick', ()=> bankZone.appendChild(wrap));
      return wrap;
    }

    function clearZones(){ answerZone.innerHTML = ''; bankZone.innerHTML = ''; }

    function shuffle(a){
      const arr=[...a]; for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
      return arr;
    }

    function loadSentence(idx, doShuffle=true){
      current = idx; selectEl.value = String(idx);
      statusEl.textContent = '';
      clearZones();

      const order = doShuffle ? shuffle([...DATA[idx].hanzi.keys()]) : [...DATA[idx].hanzi.keys()];
      order.forEach(ti=> bankZone.appendChild(createToken(idx, ti)));
    }

    function checkAnswer(){
      const target = DATA[current].hanzi.join('');
      const built = [...answerZone.querySelectorAll('.token')].map(el=>el.dataset.hanzi).join('');
      if (built === target){ statusEl.textContent='âœ… Correct! Great job.'; statusEl.className='status ok'; }
      else { statusEl.textContent='âš ï¸ Not yet. Keep arranging!'; statusEl.className='status err'; }
    }

    // ----- Drag & Drop zones with BEFORE/AFTER marker -----
    [answerZone, bankZone].forEach(zone=>{
      zone.addEventListener('dragover', e=>{
        e.preventDefault();
        zone.classList.add('drop-hover');

        const pos = getInsertPosition(zone, e.clientX, e.clientY);
        showMarker(zone, pos);
      });

      zone.addEventListener('dragleave', ()=>{
        zone.classList.remove('drop-hover');
        hideMarker();
      });

      zone.addEventListener('drop', e=>{
        e.preventDefault();
        zone.classList.remove('drop-hover');

        const id = e.dataTransfer.getData('text/plain');
        const [si, ti] = id.split('-').map(Number);
        const token = document.querySelector(`.token[data-hanzi="${CSS.escape(DATA[si].hanzi[ti])}"]`);
        if (!token) { hideMarker(); return; }

        const pos = getInsertPosition(zone, e.clientX, e.clientY);
        insertAtPosition(zone, token, pos);
        hideMarker();
      });
    });

    // Decide target reference + before/after
    function getInsertPosition(container, x, y){
      const tokens = [...container.querySelectorAll('.token')];
      if (tokens.length === 0) return { ref:null, where:'append' };

      // find closest token
      let closest=null, min=Infinity;
      tokens.forEach(el=>{
        const r=el.getBoundingClientRect();
        const cx=r.left+r.width/2, cy=r.top+r.height/2;
        const d=Math.hypot(x-cx,y-cy);
        if(d<min){min=d;closest=el;}
      });

      const r = closest.getBoundingClientRect();
      const before = x < (r.left + r.width/2);
      return { ref: closest, where: before ? 'before' : 'after' };
    }

    function insertAtPosition(container, el, pos){
      const { ref, where } = pos;
      if (!ref) { container.appendChild(el); return; }
      if (where === 'before') container.insertBefore(el, ref);
      else container.insertBefore(el, ref.nextSibling);
    }

    function showMarker(container, pos){
      const { ref, where } = pos;
      if (!ref){ hideMarker(); return; }
      marker.textContent = where === 'before' ? '<' : '>';
      marker.style.display = 'inline-flex';
      // place marker node before/after the reference
      if (where === 'before') container.insertBefore(marker, ref);
      else container.insertBefore(marker, ref.nextSibling);
    }
    function hideMarker(){
      if (marker.parentNode) marker.parentNode.removeChild(marker);
      marker.style.display = 'none';
    }

    // Controls
    btnShuffle.addEventListener('click', ()=> loadSentence(current, true));
    btnReset.addEventListener('click', ()=> loadSentence(current, false));
    btnCheck.addEventListener('click', checkAnswer);
    btnNext.addEventListener('click', ()=>{
      const next = (current+1) % DATA.length;
      loadSentence(next, true);
    });
    selectEl.addEventListener('change', e=> loadSentence(Number(e.target.value), true));

    // Start
    (function start(){
      initSelect();
      // attach marker root (anywhere so it exists)
      document.body.appendChild(marker);
      loadSentence(0, true);
    })();
  </script>
</body>
</html>
